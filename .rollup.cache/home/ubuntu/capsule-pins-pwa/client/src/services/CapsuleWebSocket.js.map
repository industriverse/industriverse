{"version":3,"file":"CapsuleWebSocket.js","sourceRoot":"","sources":["CapsuleWebSocket.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * CapsuleWebSocket Service\n * \n * Manages WebSocket connection to Capsule Gateway Service for real-time updates.\n * Features:\n * - Automatic reconnection with exponential backoff\n * - Heartbeat mechanism to keep connection alive\n * - Message queue for offline actions\n * - Type-safe message handling\n */\n\nimport type { CapsuleData, CapsuleUpdate } from '@/types/capsule';\n\nexport type ConnectionState = 'connecting' | 'connected' | 'disconnected' | 'error';\n\nexport type WebSocketMessage = \n  | { type: 'capsule_update'; data: CapsuleUpdate }\n  | { type: 'capsule_new'; data: CapsuleData }\n  | { type: 'capsule_removed'; data: { capsuleId: string } }\n  | { type: 'heartbeat'; data: { timestamp: string } }\n  | { type: 'auth_success'; data: { userId: string } }\n  | { type: 'auth_failed'; data: { reason: string } }\n  | { type: 'error'; data: { message: string } };\n\nexport interface CapsuleWebSocketConfig {\n  url: string;\n  authToken?: string;\n  reconnectDelay?: number;\n  maxReconnectDelay?: number;\n  heartbeatInterval?: number;\n  onStateChange?: (state: ConnectionState) => void;\n  onMessage?: (message: WebSocketMessage) => void;\n  onError?: (error: Error) => void;\n}\n\nexport class CapsuleWebSocket {\n  private ws: WebSocket | null = null;\n  private config: Required<CapsuleWebSocketConfig>;\n  private state: ConnectionState = 'disconnected';\n  private reconnectAttempts = 0;\n  private reconnectTimeout: NodeJS.Timeout | null = null;\n  private heartbeatInterval: NodeJS.Timeout | null = null;\n  private messageQueue: string[] = [];\n  private isIntentionallyClosed = false;\n\n  constructor(config: CapsuleWebSocketConfig) {\n    this.config = {\n      url: config.url,\n      authToken: config.authToken || '',\n      reconnectDelay: config.reconnectDelay || 1000,\n      maxReconnectDelay: config.maxReconnectDelay || 30000,\n      heartbeatInterval: config.heartbeatInterval || 30000,\n      onStateChange: config.onStateChange || (() => {}),\n      onMessage: config.onMessage || (() => {}),\n      onError: config.onError || (() => {})\n    };\n  }\n\n  /**\n   * Connect to WebSocket server\n   */\n  connect(): void {\n    if (this.ws?.readyState === WebSocket.OPEN || this.ws?.readyState === WebSocket.CONNECTING) {\n      console.warn('WebSocket already connected or connecting');\n      return;\n    }\n\n    this.isIntentionallyClosed = false;\n    this.setState('connecting');\n\n    try {\n      // Add auth token to URL if provided\n      const url = this.config.authToken \n        ? `${this.config.url}?token=${this.config.authToken}`\n        : this.config.url;\n\n      this.ws = new WebSocket(url);\n      this.setupEventHandlers();\n    } catch (error) {\n      this.handleError(error as Error);\n      this.scheduleReconnect();\n    }\n  }\n\n  /**\n   * Disconnect from WebSocket server\n   */\n  disconnect(): void {\n    this.isIntentionallyClosed = true;\n    this.clearReconnectTimeout();\n    this.clearHeartbeat();\n    \n    if (this.ws) {\n      this.ws.close();\n      this.ws = null;\n    }\n    \n    this.setState('disconnected');\n  }\n\n  /**\n   * Send message to server\n   */\n  send(message: object): void {\n    const payload = JSON.stringify(message);\n    \n    if (this.ws?.readyState === WebSocket.OPEN) {\n      this.ws.send(payload);\n    } else {\n      // Queue message for sending when connection is restored\n      this.messageQueue.push(payload);\n      console.warn('WebSocket not connected, message queued');\n    }\n  }\n\n  /**\n   * Get current connection state\n   */\n  getState(): ConnectionState {\n    return this.state;\n  }\n\n  /**\n   * Update auth token\n   */\n  updateAuthToken(token: string): void {\n    this.config.authToken = token;\n    \n    // Reconnect with new token if currently connected\n    if (this.state === 'connected') {\n      this.disconnect();\n      this.connect();\n    }\n  }\n\n  private setupEventHandlers(): void {\n    if (!this.ws) return;\n\n    this.ws.onopen = () => {\n      console.log('WebSocket connected');\n      this.setState('connected');\n      this.reconnectAttempts = 0;\n      this.startHeartbeat();\n      this.flushMessageQueue();\n    };\n\n    this.ws.onmessage = (event) => {\n      try {\n        const message = JSON.parse(event.data) as WebSocketMessage;\n        this.handleMessage(message);\n      } catch (error) {\n        console.error('Failed to parse WebSocket message:', error);\n      }\n    };\n\n    this.ws.onerror = (event) => {\n      const errorMessage = 'WebSocket connection failed. This is expected in development mode with mock data.';\n      \n      // Only log as warning in development, error in production\n      if (import.meta.env.DEV) {\n        console.warn('WebSocket connection unavailable:', errorMessage);\n      } else {\n        console.error('WebSocket error:', event);\n      }\n      \n      this.handleError(new Error(errorMessage));\n    };\n\n    this.ws.onclose = (event) => {\n      console.log('WebSocket closed:', event.code, event.reason);\n      this.clearHeartbeat();\n      \n      if (!this.isIntentionallyClosed) {\n        this.setState('disconnected');\n        this.scheduleReconnect();\n      }\n    };\n  }\n\n  private handleMessage(message: WebSocketMessage): void {\n    // Handle heartbeat responses\n    if (message.type === 'heartbeat') {\n      // Heartbeat received, connection is alive\n      return;\n    }\n\n    // Handle auth responses\n    if (message.type === 'auth_success') {\n      console.log('Authentication successful:', message.data.userId);\n      return;\n    }\n\n    if (message.type === 'auth_failed') {\n      console.error('Authentication failed:', message.data.reason);\n      this.setState('error');\n      return;\n    }\n\n    // Forward message to callback\n    this.config.onMessage(message);\n  }\n\n  private handleError(error: Error): void {\n    this.setState('error');\n    \n    // Don't trigger error callback in development mode for connection failures\n    if (!import.meta.env.DEV || !error.message.includes('expected in development')) {\n      this.config.onError(error);\n    }\n  }\n\n  private setState(newState: ConnectionState): void {\n    if (this.state !== newState) {\n      this.state = newState;\n      this.config.onStateChange(newState);\n    }\n  }\n\n  private scheduleReconnect(): void {\n    if (this.isIntentionallyClosed) return;\n\n    this.clearReconnectTimeout();\n\n    // Exponential backoff with max delay\n    const delay = Math.min(\n      this.config.reconnectDelay * Math.pow(2, this.reconnectAttempts),\n      this.config.maxReconnectDelay\n    );\n\n    console.log(`Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts + 1})`);\n\n    this.reconnectTimeout = setTimeout(() => {\n      this.reconnectAttempts++;\n      this.connect();\n    }, delay);\n  }\n\n  private clearReconnectTimeout(): void {\n    if (this.reconnectTimeout) {\n      clearTimeout(this.reconnectTimeout);\n      this.reconnectTimeout = null;\n    }\n  }\n\n  private startHeartbeat(): void {\n    this.clearHeartbeat();\n\n    this.heartbeatInterval = setInterval(() => {\n      if (this.ws?.readyState === WebSocket.OPEN) {\n        this.send({ type: 'heartbeat', timestamp: new Date().toISOString() });\n      }\n    }, this.config.heartbeatInterval);\n  }\n\n  private clearHeartbeat(): void {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n      this.heartbeatInterval = null;\n    }\n  }\n\n  private flushMessageQueue(): void {\n    while (this.messageQueue.length > 0 && this.ws?.readyState === WebSocket.OPEN) {\n      const message = this.messageQueue.shift();\n      if (message) {\n        this.ws.send(message);\n      }\n    }\n  }\n}\n"]}