{"version":3,"file":"useComposition.js","sourceRoot":"","sources":["useComposition.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,MAAM,EAAE,MAAM,OAAO,CAAC;AAC/B,OAAO,EAAE,YAAY,EAAE,MAAM,gBAAgB,CAAC;AAqB9C,MAAM,UAAU,cAAc,CAE5B,OAAsC;IAAtC,wBAAA,EAAA,YAAsC;IAEpC,IAAW,iBAAiB,GAG1B,OAAO,UAHmB,EACR,0BAA0B,GAE5C,OAAO,mBAFqC,EAC5B,wBAAwB,GACxC,OAAO,iBADiC,CAChC;IAEZ,IAAM,CAAC,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC;IACxB,IAAM,KAAK,GAAG,MAAM,CAAuB,IAAI,CAAC,CAAC;IACjD,IAAM,MAAM,GAAG,MAAM,CAAuB,IAAI,CAAC,CAAC;IAElD,IAAM,kBAAkB,GAAG,YAAY,CAAC,UAAC,CAA4B;QACnE,IAAI,KAAK,CAAC,OAAO,EAAE,CAAC;YAClB,YAAY,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;YAC5B,KAAK,CAAC,OAAO,GAAG,IAAI,CAAC;QACvB,CAAC;QACD,IAAI,MAAM,CAAC,OAAO,EAAE,CAAC;YACnB,YAAY,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;YAC7B,MAAM,CAAC,OAAO,GAAG,IAAI,CAAC;QACxB,CAAC;QACD,CAAC,CAAC,OAAO,GAAG,IAAI,CAAC;QACjB,0BAA0B,aAA1B,0BAA0B,uBAA1B,0BAA0B,CAAG,CAAC,CAAC,CAAC;IAClC,CAAC,CAAC,CAAC;IAEH,IAAM,gBAAgB,GAAG,YAAY,CAAC,UAAC,CAA4B;QACjE,oEAAoE;QACpE,KAAK,CAAC,OAAO,GAAG,UAAU,CAAC;YACzB,MAAM,CAAC,OAAO,GAAG,UAAU,CAAC;gBAC1B,CAAC,CAAC,OAAO,GAAG,KAAK,CAAC;YACpB,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QACH,wBAAwB,aAAxB,wBAAwB,uBAAxB,wBAAwB,CAAG,CAAC,CAAC,CAAC;IAChC,CAAC,CAAC,CAAC;IAEH,IAAM,SAAS,GAAG,YAAY,CAAC,UAAC,CAAyB;QACvD,uDAAuD;QACvD,IACE,CAAC,CAAC,OAAO;YACT,CAAC,CAAC,CAAC,GAAG,KAAK,QAAQ,IAAI,CAAC,CAAC,CAAC,GAAG,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,EAC1D,CAAC;YACD,CAAC,CAAC,eAAe,EAAE,CAAC;YACpB,OAAO;QACT,CAAC;QACD,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAG,CAAC,CAAC,CAAC;IACzB,CAAC,CAAC,CAAC;IAEH,IAAM,WAAW,GAAG,YAAY,CAAC;QAC/B,OAAO,CAAC,CAAC,OAAO,CAAC;IACnB,CAAC,CAAC,CAAC;IAEH,OAAO;QACL,kBAAkB,oBAAA;QAClB,gBAAgB,kBAAA;QAChB,SAAS,WAAA;QACT,WAAW,aAAA;KACZ,CAAC;AACJ,CAAC","sourcesContent":["import { useRef } from \"react\";\nimport { usePersistFn } from \"./usePersistFn\";\n\nexport interface UseCompositionReturn<\n  T extends HTMLInputElement | HTMLTextAreaElement,\n> {\n  onCompositionStart: React.CompositionEventHandler<T>;\n  onCompositionEnd: React.CompositionEventHandler<T>;\n  onKeyDown: React.KeyboardEventHandler<T>;\n  isComposing: () => boolean;\n}\n\nexport interface UseCompositionOptions<\n  T extends HTMLInputElement | HTMLTextAreaElement,\n> {\n  onKeyDown?: React.KeyboardEventHandler<T>;\n  onCompositionStart?: React.CompositionEventHandler<T>;\n  onCompositionEnd?: React.CompositionEventHandler<T>;\n}\n\ntype TimerResponse = ReturnType<typeof setTimeout>;\n\nexport function useComposition<\n  T extends HTMLInputElement | HTMLTextAreaElement = HTMLInputElement,\n>(options: UseCompositionOptions<T> = {}): UseCompositionReturn<T> {\n  const {\n    onKeyDown: originalOnKeyDown,\n    onCompositionStart: originalOnCompositionStart,\n    onCompositionEnd: originalOnCompositionEnd,\n  } = options;\n\n  const c = useRef(false);\n  const timer = useRef<TimerResponse | null>(null);\n  const timer2 = useRef<TimerResponse | null>(null);\n\n  const onCompositionStart = usePersistFn((e: React.CompositionEvent<T>) => {\n    if (timer.current) {\n      clearTimeout(timer.current);\n      timer.current = null;\n    }\n    if (timer2.current) {\n      clearTimeout(timer2.current);\n      timer2.current = null;\n    }\n    c.current = true;\n    originalOnCompositionStart?.(e);\n  });\n\n  const onCompositionEnd = usePersistFn((e: React.CompositionEvent<T>) => {\n    // 使用两层 setTimeout 来处理 Safari 浏览器中 compositionEnd 先于 onKeyDown 触发的问题\n    timer.current = setTimeout(() => {\n      timer2.current = setTimeout(() => {\n        c.current = false;\n      });\n    });\n    originalOnCompositionEnd?.(e);\n  });\n\n  const onKeyDown = usePersistFn((e: React.KeyboardEvent<T>) => {\n    // 在 composition 状态下，阻止 ESC 和 Enter（非 shift+Enter）事件的冒泡\n    if (\n      c.current &&\n      (e.key === \"Escape\" || (e.key === \"Enter\" && !e.shiftKey))\n    ) {\n      e.stopPropagation();\n      return;\n    }\n    originalOnKeyDown?.(e);\n  });\n\n  const isComposing = usePersistFn(() => {\n    return c.current;\n  });\n\n  return {\n    onCompositionStart,\n    onCompositionEnd,\n    onKeyDown,\n    isComposing,\n  };\n}\n"]}