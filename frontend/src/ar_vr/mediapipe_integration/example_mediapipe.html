<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaPipe Integration - Gesture-Free Capsule Selection</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      overflow: hidden;
    }
    
    #container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    
    #video {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 320px;
      height: 240px;
      border: 2px solid #00d4ff;
      border-radius: 8px;
      transform: scaleX(-1); /* Mirror video */
      z-index: 10;
    }
    
    #canvas {
      width: 100%;
      height: 100%;
    }
    
    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      min-width: 250px;
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    
    #controls h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #00d4ff;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-group h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #888;
    }
    
    .control-button {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .control-button:hover {
      background: #2a2a2a;
      border-color: #00d4ff;
    }
    
    .control-button.active {
      background: #00d4ff;
      color: #000;
      border-color: #00d4ff;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #222;
      font-size: 12px;
    }
    
    .status-item:last-child {
      border-bottom: none;
    }
    
    .status-label {
      color: #888;
    }
    
    .status-value {
      color: #00d4ff;
      font-weight: bold;
    }
    
    #gesture-display {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    
    #gesture-display h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #00d4ff;
    }
    
    .gesture-row {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
    }
    
    .gesture-col {
      flex: 1;
    }
    
    .gesture-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 5px;
    }
    
    .gesture-value {
      font-size: 20px;
      color: #00d4ff;
      font-weight: bold;
    }
    
    .gesture-value.active {
      color: #00ff00;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    #instructions {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #00d4ff;
      border-radius: 12px;
      padding: 40px;
      max-width: 600px;
      text-align: center;
      z-index: 20;
    }
    
    #instructions h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #00d4ff;
    }
    
    #instructions p {
      font-size: 14px;
      line-height: 1.6;
      color: #ccc;
      margin-bottom: 15px;
    }
    
    #instructions ul {
      text-align: left;
      margin: 20px 0;
      padding-left: 20px;
    }
    
    #instructions li {
      margin-bottom: 10px;
      color: #ccc;
    }
    
    #instructions button {
      padding: 12px 30px;
      background: #00d4ff;
      color: #000;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    #instructions button:hover {
      background: #00b8e6;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Video feed -->
    <video id="video" autoplay playsinline></video>
    
    <!-- Three.js canvas -->
    <canvas id="canvas"></canvas>
    
    <!-- Controls panel -->
    <div id="controls">
      <h2>Controls</h2>
      
      <div class="control-group">
        <h3>Tracking</h3>
        <button class="control-button" id="btn-hands">Enable Hand Tracking</button>
        <button class="control-button" id="btn-pose">Enable Pose Tracking</button>
      </div>
      
      <div class="control-group">
        <h3>Status</h3>
        <div class="status-item">
          <span class="status-label">Hand FPS:</span>
          <span class="status-value" id="hand-fps">0</span>
        </div>
        <div class="status-item">
          <span class="status-label">Pose FPS:</span>
          <span class="status-value" id="pose-fps">0</span>
        </div>
        <div class="status-item">
          <span class="status-label">Render FPS:</span>
          <span class="status-value" id="render-fps">0</span>
        </div>
      </div>
    </div>
    
    <!-- Gesture display -->
    <div id="gesture-display">
      <h3>Detected Gestures & Commands</h3>
      
      <div class="gesture-row">
        <div class="gesture-col">
          <div class="gesture-label">Hand Gesture</div>
          <div class="gesture-value" id="hand-gesture">None</div>
        </div>
        <div class="gesture-col">
          <div class="gesture-label">Body Language</div>
          <div class="gesture-value" id="body-language">None</div>
        </div>
        <div class="gesture-col">
          <div class="gesture-label">Selected Capsule</div>
          <div class="gesture-value" id="selected-capsule">None</div>
        </div>
      </div>
      
      <div class="gesture-row">
        <div class="gesture-col">
          <div class="gesture-label">Posture</div>
          <div class="gesture-value" id="posture">Unknown</div>
        </div>
        <div class="gesture-col">
          <div class="gesture-label">Ergonomic Risk</div>
          <div class="gesture-value" id="ergonomic-risk">Low</div>
        </div>
        <div class="gesture-col">
          <div class="gesture-label">REBA Score</div>
          <div class="gesture-value" id="reba-score">1</div>
        </div>
      </div>
    </div>
    
    <!-- Instructions overlay -->
    <div id="instructions">
      <h2>ðŸŽ¯ Gesture-Free Capsule Selection</h2>
      <p>Experience the future of Ambient Intelligence with MediaPipe-powered interaction!</p>
      
      <ul>
        <li><strong>Point</strong> at a capsule to highlight it</li>
        <li><strong>Pinch</strong> your fingers to select</li>
        <li><strong>Open palm</strong> to dismiss</li>
        <li><strong>Thumbs up</strong> to acknowledge</li>
        <li><strong>Wave hand</strong> to dismiss all</li>
      </ul>
      
      <p><em>No controllers, no touch, just natural gestures!</em></p>
      
      <button id="btn-start">Start Experience</button>
    </div>
  </div>
  
  <script type="module">
    import * as THREE from 'three';
    import MediaPipeHandsController from './MediaPipeHandsController.js';
    import MediaPipePoseController from './MediaPipePoseController.js';
    
    // ========================================================================
    // Setup
    // ========================================================================
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const instructions = document.getElementById('instructions');
    
    let handsController;
    let poseController;
    let scene, camera, renderer;
    let capsules = [];
    let renderFPS = 0;
    let lastRenderTime = 0;
    
    // ========================================================================
    // Initialize Three.js Scene
    // ========================================================================
    
    function initScene() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0a0a0a);
      
      camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 1.6, 3);
      
      renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      
      // Add lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 5, 5);
      scene.add(directionalLight);
      
      // Add demo capsules
      addDemoCapsules();
    }
    
    function addDemoCapsules() {
      const capsuleData = [
        { title: 'Critical Alert', color: 0xff3333, position: new THREE.Vector3(-1.5, 1.5, 0) },
        { title: 'Warning', color: 0xffaa33, position: new THREE.Vector3(0, 1.5, 0) },
        { title: 'Active', color: 0x33ff33, position: new THREE.Vector3(1.5, 1.5, 0) }
      ];
      
      capsuleData.forEach((data) => {
        const geometry = new THREE.SphereGeometry(0.15, 32, 32);
        const material = new THREE.MeshStandardMaterial({
          color: data.color,
          emissive: data.color,
          emissiveIntensity: 0.3
        });
        
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.copy(data.position);
        mesh.userData.type = 'capsule_overlay';
        mesh.userData.title = data.title;
        mesh.userData.originalEmissiveIntensity = 0.3;
        
        scene.add(mesh);
        capsules.push(mesh);
      });
    }
    
    // ========================================================================
    // Initialize MediaPipe Controllers
    // ========================================================================
    
    async function initMediaPipe() {
      // Request webcam access
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      
      // Initialize Hands Controller
      handsController = new MediaPipeHandsController({
        videoElement: video,
        scene,
        camera,
        onHandDetected: (hand) => {
          // Update UI
        },
        onGesture: (gesture) => {
          updateGestureDisplay('hand', gesture.type);
        },
        onCapsuleSelect: (capsule) => {
          highlightCapsule(capsule);
          updateSelectedCapsule(capsule.userData.title);
        },
        onCapsuleDismiss: (capsule) => {
          unhighlightCapsule(capsule);
          updateSelectedCapsule('None');
        }
      });
      
      // Initialize Pose Controller
      poseController = new MediaPipePoseController({
        videoElement: video,
        onPoseDetected: (pose) => {
          updatePostureDisplay(pose.posture);
          updateErgonomicRisk(pose.ergonomicRisk);
        },
        onBodyLanguage: (command) => {
          updateGestureDisplay('body', command.type);
          handleBodyLanguageCommand(command);
        }
      });
    }
    
    // ========================================================================
    // UI Updates
    // ========================================================================
    
    function updateGestureDisplay(type, gesture) {
      const element = type === 'hand' 
        ? document.getElementById('hand-gesture')
        : document.getElementById('body-language');
      
      element.textContent = gesture.replace(/_/g, ' ').toUpperCase();
      element.classList.add('active');
      
      setTimeout(() => {
        element.classList.remove('active');
      }, 1000);
    }
    
    function updateSelectedCapsule(title) {
      document.getElementById('selected-capsule').textContent = title;
    }
    
    function updatePostureDisplay(posture) {
      document.getElementById('posture').textContent = posture.toUpperCase();
    }
    
    function updateErgonomicRisk(risk) {
      document.getElementById('ergonomic-risk').textContent = risk.riskLevel.toUpperCase();
      document.getElementById('reba-score').textContent = risk.rebaScore;
      
      // Color code risk level
      const element = document.getElementById('ergonomic-risk');
      if (risk.riskLevel === 'low') {
        element.style.color = '#00ff00';
      } else if (risk.riskLevel === 'medium') {
        element.style.color = '#ffaa33';
      } else if (risk.riskLevel === 'high') {
        element.style.color = '#ff6633';
      } else {
        element.style.color = '#ff3333';
      }
    }
    
    function highlightCapsule(capsule) {
      capsule.material.emissiveIntensity = 0.8;
      capsule.scale.set(1.2, 1.2, 1.2);
    }
    
    function unhighlightCapsule(capsule) {
      capsule.material.emissiveIntensity = capsule.userData.originalEmissiveIntensity;
      capsule.scale.set(1, 1, 1);
    }
    
    function handleBodyLanguageCommand(command) {
      if (command.type === 'thumbs_up') {
        console.log('Capsule acknowledged!');
      } else if (command.type === 'wave_hand') {
        console.log('All capsules dismissed!');
        capsules.forEach(unhighlightCapsule);
        updateSelectedCapsule('None');
      }
    }
    
    // ========================================================================
    // Render Loop
    // ========================================================================
    
    function animate() {
      requestAnimationFrame(animate);
      
      // Calculate render FPS
      const now = performance.now();
      if (lastRenderTime > 0) {
        renderFPS = 1000 / (now - lastRenderTime);
      }
      lastRenderTime = now;
      
      // Update FPS displays
      if (handsController) {
        document.getElementById('hand-fps').textContent = handsController.getFPS().toFixed(1);
      }
      if (poseController) {
        document.getElementById('pose-fps').textContent = poseController.getFPS().toFixed(1);
      }
      document.getElementById('render-fps').textContent = renderFPS.toFixed(1);
      
      // Render scene
      renderer.render(scene, camera);
    }
    
    // ========================================================================
    // Event Handlers
    // ========================================================================
    
    document.getElementById('btn-start').addEventListener('click', async () => {
      instructions.style.display = 'none';
      await initMediaPipe();
      initScene();
      animate();
    });
    
    document.getElementById('btn-hands').addEventListener('click', () => {
      const button = document.getElementById('btn-hands');
      
      if (button.classList.contains('active')) {
        handsController.stop();
        button.classList.remove('active');
        button.textContent = 'Enable Hand Tracking';
      } else {
        handsController.start();
        button.classList.add('active');
        button.textContent = 'Disable Hand Tracking';
      }
    });
    
    document.getElementById('btn-pose').addEventListener('click', () => {
      const button = document.getElementById('btn-pose');
      
      if (button.classList.contains('active')) {
        poseController.stop();
        button.classList.remove('active');
        button.textContent = 'Enable Pose Tracking';
      } else {
        poseController.start();
        button.classList.add('active');
        button.textContent = 'Disable Pose Tracking';
      }
    });
    
    // Window resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
