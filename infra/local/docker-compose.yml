version: '3.8'
services:
  postgres:
    image: postgres:15
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT}:5432"

  qdrant:
    image: qdrant/qdrant:latest
    command: ["qdrant", "--host", "0.0.0.0", "--port", "6333"]
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage

  neo4j:
    image: neo4j:5.11
    environment:
      NEO4J_AUTH: "${NEO4J_USER}/${NEO4J_PASSWORD}"
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data

  nats:
    image: nats:2.10.4
    command: ["-DV"]
    ports:
      - "4222:4222"
      - "8222:8222"

  kafka:
    image: bitnami/kafka:latest
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_LISTENERS=PLAINTEXT://:9092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker:9092
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper

  zookeeper:
    image: bitnami/zookeeper:latest
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports:
      - "2181:2181"

  websocket-bridge:
    image: python:3.11-slim
    volumes:
      - ./ws:/app
    working_dir: /app
    command: ["python", "ws_bridge.py"]
    depends_on:
      - nats
    ports:
      - "8765:8765"

volumes:
  pgdata:
  qdrant_storage:
  neo4j_data:
