import json
import time
from pathlib import Path
from typing import Dict, Any

class PoVReportGenerator:
    """
    Generates the Investor-Ready Proof of Value (PoV) Report.
    Aggregates financial data and ZK audit proofs from the pilot log.
    """
    def __init__(self, log_path: str = "pilot_pov_log.jsonl"):
        self.log_path = Path(log_path)
        self.report_path = Path("pov_report.md")

    def generate_report(self):
        """
        Reads the log and writes the Markdown report.
        """
        if not self.log_path.exists():
            print(f"âš ï¸ Log file {self.log_path} not found.")
            return

        print(f"ðŸ“„ Generating PoV Report from {self.log_path}...")
        
        logs = []
        with open(self.log_path, 'r') as f:
            for line in f:
                if line.strip():
                    logs.append(json.loads(line))

        # Extract Financial Audit
        financials = next((l['data'] for l in logs if l.get('type') == 'FINANCIAL_AUDIT'), None)
        
        # Extract Optimization Actions
        optimizations = [l for l in logs if l.get('action') == 'OPTIMIZE']
        
        # Generate Markdown
        markdown = self._build_markdown(financials, optimizations, len(logs))
        
        with open(self.report_path, 'w') as f:
            f.write(markdown)
            
        print(f"âœ… Report Generated: {self.report_path}")

    def _build_markdown(self, financials: Dict[str, Any], optimizations: list, total_steps: int) -> str:
        timestamp = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
        
        kwh_saved = financials.get('kwh_saved', 0.0) if financials else 0.0
        cost_saved = financials.get('cost_saved_usd', 0.0) if financials else 0.0
        credits = financials.get('entropy_credits_minted', 0.0) if financials else 0.0
        proof = financials.get('audit_proof', 'PENDING') if financials else 'N/A'
        
        return f"""# âš¡ Sovereign Intelligence: Pilot Proof of Value (PoV)

**Date**: {timestamp}
**System**: Dark Factory Lite (Pilot)
**Asset**: TWIN-001 (Industrial Cooling Simulation)

---

## 1. Executive Summary
This report documents the energy savings achieved by the **Sovereign Intelligence Platform** during a controlled pilot run.
The system utilized **Physics-First Learning** (Entropy Minimization) to optimize the control loop of an industrial asset, reducing energy waste without compromising operational constraints.

## 2. Financial Impact
| Metric | Value |
| :--- | :--- |
| **Total Energy Saved** | **{kwh_saved:.6f} kWh** |
| **Cost Savings** | **${cost_saved:.6f}** |
| **Entropy Credits Minted** | **{credits:.6f}** |
| **Optimization Actions** | {len(optimizations)} / {total_steps} Steps |

> [!IMPORTANT]
> These savings were achieved autonomously by the `DarkFactoryPilot` agent using the `EnergyAtlas` to recall lower-entropy physics baselines.

## 3. Audit Trail (ZK Proof)
Every financial claim is cryptographically chained.
**Final Audit Hash**: `{proof}`

### Optimization Log (Sample)
```json
{json.dumps(optimizations[0] if optimizations else {}, indent=2)}
```

---
*Generated by Industriverse PoV Engine*
"""

if __name__ == "__main__":
    generator = PoVReportGenerator()
    generator.generate_report()
