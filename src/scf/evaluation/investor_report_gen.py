from typing import Dict
import time
from src.scf.evaluation.roi_calculator import ROICalculator

class InvestorReportGenerator:
    """
    Generates investor-grade reports in Markdown format.
    """
    def __init__(self):
        self.roi_calc = ROICalculator()

    def generate_report(self, 
                        client_name: str, 
                        energy_saved_kwh: float, 
                        capex: float,
                        kwh_price: float = 0.12) -> str:
        """
        Generate a full report string.
        """
        # Calculate Metrics
        cost_saved = self.roi_calc.calculate_cost_saved(energy_saved_kwh, kwh_price)
        annual_savings = cost_saved * 52 # Assuming weekly data extrapolated
        payback = self.roi_calc.calculate_payback_period(annual_savings, capex)
        npv = self.roi_calc.calculate_npv(annual_savings, capex)
        carbon_credits = self.roi_calc.calculate_carbon_credits(energy_saved_kwh * 52) # Annualized
        
        report = f"""# ðŸ“Š Sovereign Energy Intelligence Report
**Client**: {client_name}
**Date**: {time.strftime("%Y-%m-%d")}

## 1. Executive Summary
The deployment of the Sovereign Engine has resulted in significant energy efficiency improvements.
Projected annual savings are **${annual_savings:,.2f}** with a payback period of **{payback:.1f} years**.

## 2. Financial Analysis (5-Year Horizon)
| Metric | Value |
| :--- | :--- |
| **Initial Investment (CAPEX)** | ${capex:,.2f} |
| **Annual Energy Savings** | ${annual_savings:,.2f} |
| **Net Present Value (NPV)** | **${npv:,.2f}** |
| **ROI (Year 1)** | {((annual_savings - capex)/capex)*100:.1f}% |

## 3. Environmental Impact (ESG)
| Metric | Value |
| :--- | :--- |
| **Energy Saved (Annual)** | {energy_saved_kwh * 52:,.0f} kWh |
| **Carbon Reduction** | {carbon_credits:.2f} tons CO2e |
| **Entropy Credits Earned** | {carbon_credits:.2f} Credits |

> [!TIP]
> This project qualifies for **Tier-1 Green Energy Rebates** in most jurisdictions.

---
*Generated by Industriverse Sovereign Engine*
"""
        return report

    def save_report(self, report_content: str, filename: str = "investor_report.md"):
        with open(filename, "w") as f:
            f.write(report_content)
        print(f"ðŸ“„ Report saved to {filename}")
